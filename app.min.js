function error(e,t,n){var o=new Error
return o.name=e,o.message=t,o.status=n,o}function redirectToAmazon(e){e.statusCode=302
var t="https://"+config.lwaRedirectHost+"/ap/oa",n=t+"?client_id="+config.avsClientId+"&response_type=code&redirect_uri="+config.avsRedirectUrl,o=uuid.v4(),s={productID:config.avsProductId,productInstanceAttributes:{deviceSerialNumber:config.dsn}},i={}
console.log("LWA url : "+n),i["alexa:all"]=s
var r="&scope="+encodeURIComponent("alexa:all")+"&state="+encodeURIComponent(o)+"&scope_data="+encodeURIComponent(JSON.stringify(i)),a=n+r
console.log("final url : "+a),e.setHeader("Location",a),e.end()}function simpleStringify(e){var t={}
for(var n in e)e.hasOwnProperty(n)&&"object"!=typeof e[n]&&"function"!=typeof e[n]&&(t[n]=e[n])
return JSON.stringify(t)}getAccessToken=function(e,t){console.log("into the function"+e)
var n=!1,o=getLwaPostOptions("/auth/o2/token"),s="grant_type=refresh_token&refresh_token="+e+"&redirect_uri="+config.avsRedirectUrl+"&client_id="+config.avsClientId+"&client_secret="+config.avsClientSecret,i=https.request(o,function(e){var o=null
e.on("end",function(){if(200===e.statusCode&&null!==o){var s=JSON.parse(o),i="accessToken="+s.access_token+"\n"
i+="expiresIn="+s.expires_in+"\n",i+="refreshToken="+s.refresh_token+"\n",i+="tokenType="+s.token_type
var r=require("./newtokenAlexa.json")
r.authDelegate.refreshToken=s.refresh_token,fs.writeFile(process.env["win32"==process.platform?"USERPROFILE":"HOME"]+"/newtokenAlexa.json",JSON.stringify(r),function(e){return e?console.log(e):void console.log("avs-token file updated successfully!")}),fs.writeFile("./newtokenAlexa.json",JSON.stringify(r),function(e){return e?console.log(e):void console.log("avs-token file updated successfully!")}),!n&&t(null,"device tokens ready"),n=!0}else!n&&t(error("TokenRetrievalFailure","Unexpected failure while retrieving tokens.",e.statusCode)),n=!0}),e.on("data",function(s){200===e.statusCode?o=null===o?s:Buffer.concat([o,s]):(!n&&t(error("TokenRetrievalFailure","Unexpected failure while retrieving tokens.",e.statusCode)),n=!0)})})
i.on("error",function(e){console.error("Failed to post request: "+e.message)}),i.write(s),i.end()}
var regHelper=require("./RegHelper.js")
avsProps=regHelper.avsProps,apps=regHelper.apps,duetRegisters=regHelper.duetReg,duetRegisterConversion=regHelper.regconversion,duetRegisterFractionalBits=regHelper.regFractions,duetRegisterIds=regHelper.regIds,eqIndices=regHelper.eqind,properties=regHelper.properties,eqWisceText=regHelper.eqWisceText,filterGainWisceTest=regHelper.filterGainWisceTest
var Mustache=require("mustache"),json=require("comment-json"),rpiStatus=require("rpi-status"),serialNumber=rpiStatus.getSerialNumber()
console.log("raspberry serial number : "+serialNumber),properties.forEach(function(e){var t=apps[e.app]
t&&("properties"in t||(t.properties=[]),t.properties.push(e))}),getPropsByValue=function(){return propsByVar={},properties.forEach(function(e){propsByVar[e.variable]=e}),propsByVar},getPropsByName=function(){return propsByPropName={},properties.forEach(function(e){propsByPropName[e.property]=e}),propsByPropName}
var tinymixSetReadRegIDCommand='tinymix set "DSP3Y Misc 1005 READREGID" ',tinymixSetWriteRegIDCommand='tinymix set "DSP3Y Misc 1005 WRITEREGID" ',tinymixGetCommand="tinymix get ",tinymixSetCommand="tinymix set ",eqGetCoefCommand="./WMEqFilters.exe Coefficients ",eqGetSettingsCommand="./WMEqFilters.exe Settings ",eqGetResponseCommand="./WMEqFilters.exe Response ",micSource=0,micSourceCommand='nanomix "DSP2L Input 1"',https=require("https"),uuid=require("node-uuid"),PropertiesReader=require("properties-reader"),exec=require("child_process").exec,fs=require("fs"),request=require("request"),NetworkConfigurations=require("./network.js"),configPath=process.env["win32"==process.platform?"USERPROFILE":"HOME"]+"/console-app/console.properties"
config={},duetConfig={},eqRegisters={},localIP="",wifiIP="",readConfigFile=function(){var e=PropertiesReader(configPath)
config={},properties.forEach(function(t){"dsn"==t.property?config[t.variable]=serialNumber:config[t.variable]=e.getRaw(t.property)}),console.log("config...."+JSON.stringify(config))},readConfigFile()
var toRegister=function(e,t){var n=e
1==duetRegisterConversion[t]&&(n=Math.pow(10,e/20)),n=Math.round(n*Math.pow(2,duetRegisterFractionalBits[t]))
var o=n.toString(16)
if(o.length<8){for(var s="",i=0;i<8-o.length;i++)s+="0"
o=s+o}return console.log("toRegister",o),o},fromRegister=function(e,t){var n=e/Math.pow(2,duetRegisterFractionalBits[t])
return 1==duetRegisterConversion[t]?(20*Math.log10(n)).toFixed(4):n},eqSetCoefficients=function(e,t,n,o){var s
s="0001"==o&&1==e?1:0
var i=exec(eqGetCoefCommand+e+" "+s+" "+t+" "+n)
console.log("eqSetCoefficients : "+eqGetCoefCommand+e+" "+s+" "+t+" "+n),i.stdout.on("data",function(e,t){var n=t.split(" ").join("")
n=n.split(","),console.log("res: "+n)
var o=n[0].trim(),s=n[1].trim(),i=n[2].trim(),r=n[3].trim()
if(1==e)eqRegisters.band1a=o,eqRegisters.band1b=s,eqRegisters.band1c=i,eqRegisters.band1pg=r
else if(2==e)eqRegisters.band2a=o,eqRegisters.band2b=s,eqRegisters.band2c=i,eqRegisters.band2pg=r
else if(3==e)eqRegisters.band3a=o,eqRegisters.band3b=s,eqRegisters.band3c=i,eqRegisters.band3pg=r
else if(4==e)eqRegisters.band4a=o,eqRegisters.band4b=s,eqRegisters.band4c=i,eqRegisters.band4pg=r
else if(5==e){eqRegisters.band5a=o,eqRegisters.band5b=s,eqRegisters.band5c=i,eqRegisters.band5pg=r
var a=""
for(var c in eqRegisters){var l=eqRegisters[c]
console.log(c+" "+l)}for(var g in eqIndices)console.log("key: "+g),a=a+" "+eqRegisters[g].substring(0,2)+" "+eqRegisters[g].substring(2,4)
var d='nanomix "'+duetRegisters.EQ+'" '+a
console.log("NANOMIX CMD : "+d),exec(d)}console.log("A coef: "+o),console.log("B coef: "+s),console.log("C coef: "+i),console.log("PG coef: "+r)}.bind(null,e))},pad_with_zeroes=function(e,t){for(var n=""+e;n.length<t;)n="0"+n
return n},eqtoWISCETxt=function(){console.log("eqWisceText : "+JSON.stringify(eqWisceText)),console.log("eq to WISCE Text : "+JSON.stringify(eqRegisters))
var e,t=""
e="0000"!=eqRegisters.bandpass?1:0
var n=pad_with_zeroes(Number(eqRegisters.filterGain1).toString(2),5),o=pad_with_zeroes(Number(eqRegisters.filterGain2).toString(2),5),s=pad_with_zeroes(Number(eqRegisters.filterGain3).toString(2),5),i=pad_with_zeroes(Number(eqRegisters.filterGain4).toString(2),5),r=pad_with_zeroes(Number(eqRegisters.filterGain5).toString(2),5),a=n+""+o+s+0,c="EQ1_B1_GAIN="+[n.slice(0,1),"_",n.slice(1)].join("")+", EQ1_B2_GAIN="+[o.slice(0,1),"_",o.slice(1)].join("")+", EQ1_B3_GAIN="+[s.slice(0,1),"_",s.slice(1)].join("")+", EQ1_ENA=0",l=i+""+r+e+"00000",g="EQ1_B4_GAIN="+[i.slice(0,1),"_",i.slice(1)].join("")+", EQ1_B5_GAIN="+[r.slice(0,1),"_",r.slice(1)].join("")+", EQ1_B1_MODE=0",d=parseInt(a,2).toString(16),u=parseInt(l,2).toString(16)
console.log("hexReg1 : "+d),console.log("hexReg2 : "+u),console.log("regDesc1 : "+c),console.log("regDesc2 : "+g),reg1Json={},reg2Json={},reg1Json.reg1=d,reg1Json.regDesc1=c
var p=Mustache.render(filterGainWisceTest.reg1,reg1Json)
reg2Json.reg2=u,reg2Json.regDesc2=g
var f=Mustache.render(filterGainWisceTest.reg2,reg2Json)
console.log("reg1Output : "+JSON.stringify(p)),console.log("reg2Output : "+JSON.stringify(f))
for(var m in eqRegisters)if(m in eqWisceText){var R=eqWisceText[m],v=eqRegisters[m],q=parseInt("0x"+v,10).toString(2),I={}
I.band=v,I.bandBin=q
var x=Mustache.render(R,I)
console.log(x),t=t+x+"\n"}fs.writeFile(process.env["win32"==process.platform?"USERPROFILE":"HOME"]+"/SampleWisce.txt",t,function(e){return e?console.log(e):void console.log("SampleWisce.txt file saved successfully!")})}
eqWISCtoReg=function(){},eqSetAllCoefficients=function(){eqSetCoefficients(1,eqRegisters.filterCutoff1,eqRegisters.filterBandwidthM1,eqRegisters.bandpass),eqSetCoefficients(2,eqRegisters.filterCutoff2,eqRegisters.filterBandwidthM2,eqRegisters.bandpass),eqSetCoefficients(3,eqRegisters.filterCutoff3,eqRegisters.filterBandwidthM3,eqRegisters.bandpass),eqSetCoefficients(4,eqRegisters.filterCutoff4,eqRegisters.filterBandwidthM4,eqRegisters.bandpass),eqSetCoefficients(5,eqRegisters.filterCutoff5,eqRegisters.filterBandwidthM5,eqRegisters.bandpass)},eqSetAllFileters=function(){var e=parseInt(eqRegisters.filterGain1)+12,t=parseInt(eqRegisters.filterGain2)+12,n=parseInt(eqRegisters.filterGain3)+12,o=parseInt(eqRegisters.filterGain4)+12,s=parseInt(eqRegisters.filterGain5)+12,i=tinymixSetCommand+'"'+duetRegisters.filterGain1+'" '+e
console.log("TEST: "+i),exec(i),i=tinymixSetCommand+'"'+duetRegisters.filterGain2+'" '+t,console.log("TEST: "+i),exec(i),i=tinymixSetCommand+'"'+duetRegisters.filterGain3+'" '+n,console.log("TEST: "+i),exec(i),i=tinymixSetCommand+'"'+duetRegisters.filterGain4+'" '+o,console.log("TEST: "+i),exec(i),i=tinymixSetCommand+'"'+duetRegisters.filterGain5+'" '+s,console.log("TEST: "+i),exec(i)},eqGetSettings=function(e,t,n,o,s,i){var r
r="0000"!=t?1:0
var a=exec(eqGetSettingsCommand+e+" "+r+" "+n+" "+o+" "+s+" "+i)
console.log("eqGetSettings : "+eqGetSettingsCommand+e+" "+r+" "+n+" "+o+" "+s+" "+i),a.stdout.on("data",function(e,t){var n=t.split(" ").join("")
n=n.split(",")
var o=parseFloat(parseFloat(n[0].trim()).toFixed(2)),s=parseFloat(parseFloat(n[1].trim()).toFixed(2)),i="filterCutoff"+e
fbm="filterBandwidthM"+e,eqRegisters[i]=o,eqRegisters[fbm]=s}.bind(null,e))},eqGetResponse=function(e){var t="0000"==eqRegisters.bandpass?0:1,n=eqGetResponseCommand+t+" "+eqRegisters.band1a+" "+eqRegisters.band1b+" "+eqRegisters.band1c+" "+eqRegisters.band1pg+" "+eqRegisters.filterGain1+" "+eqRegisters.band2a+" "+eqRegisters.band2b+" "+eqRegisters.band2c+" "+eqRegisters.band2pg+" "+eqRegisters.filterGain2+" "+eqRegisters.band3a+" "+eqRegisters.band3b+" "+eqRegisters.band3c+" "+eqRegisters.band3pg+" "+eqRegisters.filterGain3+" "+eqRegisters.band4a+" "+eqRegisters.band4b+" "+eqRegisters.band4c+" "+eqRegisters.band4pg+" "+eqRegisters.filterGain4+" "+eqRegisters.band5a+" "+eqRegisters.band5b+" 0 "+eqRegisters.band5pg+" "+eqRegisters.filterGain5
console.log("Get Response : "+n)
var o=exec(n)
o.stdout.on("data",function(e,t){for(var n=[],o=t.split("\n"),s=0;s<o.length;s++){var i=o[s].split(",")
void 0!==i[0]&&void 0!==i[1]&&n.push(parseFloat(i[1].trim()))}e.emit("new-graph-data-eq",n)}.bind(null,e)),o.stderr.on("data",function(e,t){var n=t.split("\n")
for(k in n){var o=k.split(",")
console.log("res: "+o),gContents={x:parseInt(o[0].trim()),y:parseInt(o[1].trim())},e.emit("new-graph-data-eq",gContents)}}.bind(null,e))},getAllEQSettings=function(e){for(var t in eqIndices)eqRegisters[t]=e.slice(eqIndices[t],eqIndices[t]+4)
eqGetSettings(1,eqRegisters.bandpass,eqRegisters.band1a,eqRegisters.band1b,eqRegisters.band1c,eqRegisters.band1pg),eqGetSettings(2,!1,eqRegisters.band2a,eqRegisters.band2b,eqRegisters.band2c,eqRegisters.band2pg),eqGetSettings(3,!1,eqRegisters.band3a,eqRegisters.band3b,eqRegisters.band3c,eqRegisters.band3pg),eqGetSettings(4,!1,eqRegisters.band4a,eqRegisters.band4b,eqRegisters.band4c,eqRegisters.band4pg),eqGetSettings(5,!1,eqRegisters.band5a,eqRegisters.band5b,0,eqRegisters.band5pg)},getBoardProps=function(){for(var e in duetRegisters){var t=exec(tinymixGetCommand+'"'+duetRegisters[e]+'"')
t.stdout.on("data",function(e,t){var n=t.replace(/\s/g,"")
if(n=n.replace(/,/g,""),"EQ"==e)getAllEQSettings(n)
else if(e.includes("filterGain")){console.log(e+"  :EXEC commnad: "+tinymixGetCommand+'"'+duetRegisters[e]+'"')
var o=t.split(" ")
eqRegisters[e]=parseInt(o[0])-12,console.log(e+":"+eqRegisters[e])}else{var s=parseInt(n,16),n=fromRegister(s,e)
duetConfig[e]=parseFloat(parseFloat(n).toFixed(2))}}.bind(null,e))}var t=exec(micSourceCommand)
t.stdout.on("data",function(e,t){t.replace(/\s/g,"").includes("1")}.bind(null,micSource))},getBoardProps(),getLocalIP=function(){var e=require("os"),t=e.networkInterfaces(),n=[]
try{n[0]=t.eth0[0].address}catch(e){n[0]=""}try{n[1]=t.wlan0[0].address}catch(e){n[1]=""}return console.log(n[0]+" "+n[1]),n}
var adr=getLocalIP()
localIP=adr[0],wifiIP=adr[1],module.exports=duetConfig,module.exports=eqRegisters,module.exports=micSource,module.exports=localIP,module.exports=wifiIP,readLogs=function(e,t,n){return(app=apps[e])?void(t>0?exec("tail -"+t+" "+config[app.log],function(e,t,o){return e instanceof Error?void n(error("Not Found",config[app.log]+" file not found",404)):void n(null,t)}):fs.readFile(config[app.log],"utf8",function(e,t){e?n(error("Not Found",config[app.log]+" file not found",404)):n(null,t)})):n(error("Not Found","Could not find app: "+e))},clearLog=function(e){return(app=apps.avs)?void fs.writeFile(config[app.log],"",function(t,n){t?e(error("Not Found",config[app.log]+" file not found",404)):e(null,n)}):e(error("Not Found","Could not find Property in AVS configuration"))},getAvsStatus=function(e){var t=apps.avs
return t?void exec(config[t.status],function(t,n,o){return t instanceof Error?void e(null,{app_status:"inactive"}):void(n.indexOf("Active: active")>=0||n.indexOf("service is running")>=0?e(null,{app_status:"active"}):e(null,{app_status:"inactive"}))}):e(error("Not Found","Could not find AVS Service "))},startAVS=function(e){var t=apps.avs
return t?void exec(config[t.start],function(n,o,s){return n&&n.length>1?(console.log("failed to start "+t.name+" service."),void e(error("InternalError","Failure to start "+t.name+" service",500))):(console.log("Log : "+t.name+" service started."),void e(null,{app_status:"started"}))}):e(error("Not Found","Could not find AVS Service"))},stopAVS=function(e){var t=apps.avs
return t?void exec(config[t.stop],function(n,o,s){return n instanceof Error?(console.log("failed to stop "+t.name+" service."),void e(error("InternalError","Failure to stop "+t.name+" service",500))):(console.log("Log : "+t.name+" service stopped."),void e(null,{app_status:"stopped"}))}):e(error("Not Found","Could not find AVS Service"))},triggerApp=function(e){triggerIO.avs.emit("trigger",""),e(null,"")},registerWithAmazon=function(e,t){redirectToAmazon(e)},authresponse=function(e,t,n){var o=[],s=!1
if(e||o.push("code"),t||o.push("state"),o.length>0)return void n(error("MissingParams","The following parameters were missing or empty strings: "+o.join(", "),400))
var i={host:config.lwaApiHost,path:"/auth/o2/token",method:"POST",port:443,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},rejectUnauthorized:!0},r="grant_type=authorization_code&code="+e+"&redirect_uri="+config.avsRedirectUrl+"&client_id="+config.avsClientId+"&client_secret="+config.avsClientSecret,a=https.request(i,function(e){var t=null
e.on("end",function(){if(200===e.statusCode&&null!==t){var o,i=JSON.parse(t),r=fs.readFileSync(process.env["win32"==process.platform?"USERPROFILE":"HOME"]+"/sdk-folder/sdk-build/Integration/AlexaClientSDKConfig.json")
o=json.parse(r),o.authDelegate.clientSecret=config.avsClientSecret,o.authDelegate.deviceSerialNumber=config.dsn,o.authDelegate.refreshToken=i.refresh_token,o.authDelegate.clientId=config.avsClientId,o.authDelegate.productId=config.avsProductId,fs.writeFileSync(process.env["win32"==process.platform?"USERPROFILE":"HOME"]+"/sdk-folder/sdk-build/Integration/AlexaClientSDKConfig.json",json.stringify(o,null,2)),!s&&n(null,"device tokens ready"),s=!0}else!s&&n(error("TokenRetrievalFailure","Unexpected failure while retrieving tokens.",e.statusCode)),s=!0}),e.on("data",function(o){200===e.statusCode?t=null===t?o:Buffer.concat([t,o]):(!s&&n(error("TokenRetrievalFailure","Unexpected failure while retrieving tokens.",e.statusCode)),s=!0)})})
a.on("error",function(e){console.error("Failed to post request: "+e.message)}),a.write(r),a.end()},updateConfigValues=function(e){var t=getPropsByValue()
for(key in e)key in t&&(config[key]=e[key])
updateConfigFile()},getConfig=function(){return config},updateConfigFile=function(){var e,t=getPropsByName(),n=""
fs.readFileSync(configPath).toString().split("\n").forEach(function(o){o.indexOf("=")>-1&&o.split("=")[0]in t?(e=o.split("=")[0],n+=e+"="+config[t[e].variable]+"\n"):n+=o+"\n"}),fs.writeFileSync(configPath,n)}
var LOG_LINES=1005,watchingLog={},watchlogs=function(e){fs.watch(config[apps[e].log],{encoding:"UTF8"},function(t,n){readLogs(e,LOG_LINES,function(t,n){logsocketIO[e].emit("log-update",n)})})},clientLogUpdate=function(e,t){readLogs(e,LOG_LINES,function(e,n){return e?console.log(e):void t.emit("log-update",n)})}
onLogSubscribe=function(e,t){fs.existsSync(config[apps[e].log])&&(1!=watchingLog[e]&&(watchingLog[e]=!0,watchlogs(e)),clientLogUpdate(e,t))},getWifiSettings=function(e){(new NetworkConfigurations).init(function(t){e({savedNetworks:t.get()})})},saveNetwork=function(e,t){(new NetworkConfigurations).init(function(n){n.update(e).save(function(){t&&t()})})},forgetNetwork=function(e,t){(new NetworkConfigurations).init(function(n){n.forget(e).save(function(){t&&t()})})},connectToNetwork=function(e,t){(new NetworkConfigurations).init(function(n){n.connect(e).save(function(){t&&t(),exec("sudo reboot",function(e,t,n){})})})},saveAndConnectToNetwork=function(e,t){(new NetworkConfigurations).init(function(n){n.update(e).connect(e.ssid).save(function(){t&&t(),exec("sudo reboot",function(e,t,n){})})})}
var express=require("express"),path=require("path"),bodyParser=require("body-parser"),session=require("express-session"),flash=require("connect-flash"),minify=require("express-minify"),async=require("async"),app=express()
io=void 0,app.use(minify()),app.use(session({secret:"kitkat",resave:!0,saveUninitialized:!0})),app.use(flash()),app.use(bodyParser.json()),app.use("/css",express.static(__dirname+"/public/css")),app.use("/js",express.static(__dirname+"/public/js")),app.use("/fonts",express.static(__dirname+"/public/fonts")),app.use("/images",express.static(__dirname+"/public/images")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!1})),app.use(function(e,t,n){t.locals.message=e.flash(),n()}),app.set("view engine","ejs"),app.engine("html",require("ejs").renderFile),app.get("/",function(e,t){t.render("home.html",{page:"home",localIP:localIP})}),app.get("/avs-login",function(e,t,n){t.render("avs-login.html",{page:"avsLogin",localIP:localIP})}),app.post("/avs-login",function(e,t,n){console.log(" avs-login data : ",JSON.stringify(e.body)),registerWithAmazon(t,function(e){t.status(e.status),t.send({error:e.name,message:e.message}),n(e)})}),app.get("/network-properties",function(e,t){return"raspberrypi"!=config.environmentProfile?t.send("Only Available on Raspberry Pi"):void getWifiSettings(function(e){t.render("network-config.html",{page:"networkSettings",wifiSettings:e,localIP:localIP})})}),app.get("/sample",function(e,t,n){eqtoWISCETxt(),t.send("Hello")}),app.get("/dsp-properties",function(e,t){t.render("duet-config.html",{page:"dspSettings",duetConfig:duetConfig,eqRegisters:eqRegisters,micSource:micSource,localIP:localIP,config:config,path:"/dsp-properties"})}),app.get("/avs-properties",function(e,t){t.render("avs-config.html",{page:"avsSettings",avsClientId:config.avsClientId,avsClientSecret:config.avsClientSecret,avsProductId:config.avsProductId,localIP:localIP})}),app.get("/refreshToken",function(e,t){var n,o
fs.readFile(process.env["win32"==process.platform?"USERPROFILE":"HOME"]+"/avs-token.properties",function(s,i){if(s)throw s
o=JSON.parse(i),n=o.refresh_token,getAccessToken(n,function(n,o){n?e.flash("error",n.name+" : "+n.message):(e.flash("success","token updated successfully"),exec("sudo service avs-cpp restart")),t.send("refresh token updated.!")})})}),app.post("/avs-properties",function(e,t){updateConfigValues(e.body),e.flash("success","Properties updated successfully"),t.redirect("/avs-properties")}),app.get("/clearLog",function(e,t,n){clearLog(function(e,n){e?(t.status(e.status),t.send({error:e.name,message:e.message})):t.send(n)})}),app.get("/getAppStatus",function(e,t){getAvsStatus(function(e,n){e?(t.status(e.status),t.send({error:e.name,message:e.message})):t.json(n)})}),app.get("/startApp",function(e,t){startAVS(function(e,n){e?(t.status(e.status),t.send({error:e.name,message:e.message})):t.send(n)})}),app.get("/stopApp",function(e,t){stopAVS(function(e,n){e?(t.status(e.status),t.send({error:e.name,message:e.message})):t.send(n)})}),app.post("/triggerApp",function(e,t){triggerApp(function(e,n){e?(t.setatus(e.status),t.send({error:e.name,message:e.message})):t.send(n)})}),app.get("/authresponse",function(e,t){console.log("authresponse : "+e.query.code),console.log("body data : ",JSON.stringify(e.query)),authresponse(e.query.code,e.query.state,function(n,o){n?e.flash("error",n.name+" : "+n.message):(e.flash("success","Login Successful"),exec("sudo service avs-cpp restart")),t.redirect("/avs-login")})}),app.post("/network/save",function(e,t){var n={ssid:e.body.ssid,psk:e.body.password}
saveNetwork(n,function(){t.redirect("/network-properties")})}),app.post("/network/connect",function(e,t){connectToNetwork(e.body.ssid,function(){t.redirect("/network-properties")})}),app.post("/network/save/connect",function(e,t){var n={ssid:e.body.ssid,psk:e.body.password}
saveAndConnectToNetwork(n,function(){t.redirect("/network-properties")})}),app.post("/network/forget",function(e,t){forgetNetwork(e.body.ssid,function(){t.redirect("/network-properties")})}),app.get("/setRegister",function(e,t){global.blockReading=!0
for(var n=e.query.register,o=e.query.val,s=toRegister(o,n),i="",r=0,a=s.length;r<a;r+=2)i+="0x"+s.substring(r,r+2)+" "
regQuery=tinymixSetCommand+'"'+duetRegisters[n]+'" '+i+" ;"+tinymixSetWriteRegIDCommand+"0x00 0x00 0x00 "+duetRegisterIds[n]+"; y=`"+tinymixGetCommand+'"DSP3Y Misc 1005 WRITEREGID"`; echo "$y"',console.log("regQuery",regQuery)
var c=exec(regQuery)
c.stdout.on("data",function(e){console.log("Output data "+e)}),c.on("exit",function(e){console.log("Finsihed writing to register"),global.blockReading=!1}),duetConfig[n]=o,t.send("Success")}),app.get("/setMicSource",function(e,t,n){console.log("Set Mic Source: "+e.query.val)
var o=""
o="0"==e.query.val?'nanomix "DSP2L Input 1" IN1L; nanomix "ISRC1DEC1 Input" IN1L; nanomix "ISRC1DEC2 Input" IN1R':'nanomix "DSP2L Input 1" IN2L; nanomix "ISRC1DEC1 Input" IN2L; nanomix "ISRC1DEC2 Input" IN2R',console.log(o),exec(o),micSource=parseInt(e.query.val),t.send("Success")}),app.get("/setEQ",function(e,t,n){eqRegisters.filterCutoff1=e.query.filterCutoff1,eqRegisters.filterCutoff2=e.query.filterCutoff2,eqRegisters.filterCutoff3=e.query.filterCutoff3,eqRegisters.filterCutoff4=e.query.filterCutoff4,eqRegisters.filterCutoff5=e.query.filterCutoff5,eqRegisters.filterBandwidthM1=e.query.filterBandwidthM1,eqRegisters.filterBandwidthM2=e.query.filterBandwidthM2,eqRegisters.filterBandwidthM3=e.query.filterBandwidthM3,eqRegisters.filterBandwidthM4=e.query.filterBandwidthM4,eqRegisters.filterBandwidthM5=e.query.filterBandwidthM5,eqRegisters.filterGain1=e.query.filterGain1,eqRegisters.filterGain2=e.query.filterGain2,eqRegisters.filterGain3=e.query.filterGain3,eqRegisters.filterGain4=e.query.filterGain4,eqRegisters.filterGain5=e.query.filterGain5,eqRegisters.bandpass=e.query.bandpass,eqSetAllCoefficients(),eqSetAllFileters(),t.send("Success")}),app.get("/getIP",function(e,t,n){console.log("Getting the IPs",localIP,wifiIP,".................")
var o=getLocalIP()
t.send({localIP:o[0],wifiIP:o[1]})}),app.use(function(e,t,n,o){console.log("error: ",e),n.status(e.status||500),n.send("error: "+e.message)}),global.framcnt=0,global.startframecnt=0,global.blockReading=!1
var gainDelay,clipDelay,audioModeDelay,erleDelay,dtdDelay,graphGainData=function(e){if(global.blockReading)console.log("Waiting for read to finish...")
else{var t=tinymixSetReadRegIDCommand+"0x00 0x00 0x00 0x19; x=`"+tinymixGetCommand+'"'+duetRegisters.Mic1InAbsMax+'"`; y=`'+tinymixGetCommand+'"'+duetRegisters.Mic2InAbsMax+'"`; z=`'+tinymixGetCommand+'"'+duetRegisters.LineOutAbsMax+'"`; '+tinymixSetReadRegIDCommand+"0x00 0x00 0x00 0x00; k=`"+tinymixGetCommand+'"'+duetRegisters.MicInPga+'"`; '+tinymixSetReadRegIDCommand+"0x00 0x00 0x00 0x19; t=`"+tinymixGetCommand+'"'+duetRegisters.FrameCntr+'"`; '+tinymixSetReadRegIDCommand+"0x00 0x00 0x00 0x00; j=`"+tinymixGetCommand+'"'+duetRegisters.LineInPga+'"`; '+tinymixSetReadRegIDCommand+"0x00 0x00 0x00 0x19; l=`"+tinymixGetCommand+'"'+duetRegisters.LineInAbsMax+'"`; o=`'+tinymixGetCommand+'"'+duetRegisters.SpkrOutAbsMax+'"`; echo "$x, $y, $z, $k, $t, $j, $l, $o"'
exec(t).stdout.on("data",function(e,t){var n=t.split(" ").join("")
n=n.split(",")
var o=parseInt(n[0]+n[1]+n[2]+n[3],16),s=parseInt(n[4]+n[5]+n[6]+n[7],16),i=parseInt(n[8]+n[9]+n[10]+n[11],16),r=parseInt(n[12]+n[13]+n[14]+n[15],16),a=parseInt(n[16]+n[17]+n[18]+n[19],16),c=parseInt(n[20]+n[21]+n[22]+n[23],16),l=parseInt(n[24]+n[25]+n[26]+n[27],16),g=parseInt(n[28]+n[29]+n[30]+n[31],16)
0==global.framcnt&&(global.framcnt=1,global.startframecnt=a)
var d=fromRegister(o,"Mic1InAbsMax"),u=fromRegister(s,"Mic2InAbsMax"),p=fromRegister(i,"LineOutAbsMax"),f=fromRegister(r,"MicInPga"),m=fromRegister(c,"LineInPga"),R=fromRegister(l,"LineInAbsMax"),v=fromRegister(g,"SpkrOutAbsMax"),q=(a-global.startframecnt)/250,I=20*Math.log10(d)+20*Math.log10(f),x=20*Math.log10(u)+20*Math.log10(f),C=20*Math.log10(p),b=20*Math.log10(v),y=20*Math.log10(m)+20*Math.log10(R)
b==Number.NEGATIVE_INFINITY&&(b=-99),y==Number.NEGATIVE_INFINITY&&(y=-99),b>0&&(b=0),y>0&&(y=0),I>0&&(I=0),x>0&&(x=0),C>0&&(C=0),isNaN(q)||isNaN(I)||isNaN(x)||isNaN(C)||isNaN(y)||isNaN(b)||(console.log("x: "+q+" micin1: "+I+" micin2: "+x+" lineout: "+C+" lineIn: "+y+" speaker: "+b),gContents={x:q,y1:I,y2:x,y3:C,y4:y,y5:b},e.emit("new-graph-data-gain",gContents))}.bind(null,e))}},graphEQData=function(e){eqGetResponse(e)},graphClipData=function(e){if(!global.blockReading){var t=tinymixSetReadRegIDCommand+"0x00 0x00 0x00 0x19; x=`"+tinymixGetCommand+'"'+duetRegisters.micInClip+'"`; y=`'+tinymixGetCommand+'"'+duetRegisters.mic1InClip+'"`; z=`'+tinymixGetCommand+'"'+duetRegisters.lineOutClip+'"`; k=`'+tinymixGetCommand+'"'+duetRegisters.speakerOutClip+'"`; t=`'+tinymixGetCommand+'"'+duetRegisters.lineInClip+'"`; echo "$x, $y, $z, $k, $t"'
exec(t).stdout.on("data",function(e,t){var n=t.split(" ").join("")
n=n.split(",")
var o=parseInt(n[0]+n[1]+n[2]+n[3],16),s=parseInt(n[4]+n[5]+n[6]+n[7],16),i=parseInt(n[8]+n[9]+n[10]+n[11],16),r=parseInt(n[12]+n[13]+n[14]+n[15],16),a=parseInt(n[16]+n[17]+n[18]+n[19],16),c=fromRegister(o,"micInClip"),l=fromRegister(s,"mic1InClip"),g=fromRegister(i,"lineOutClip"),d=fromRegister(r,"speakerOutClip"),u=fromRegister(a,"lineInClip")
gContents={micInClip:c,mic1InClip:l,lineOutClip:g,speakerOutClip:d,lineInClip:u},e.emit("new-graph-data-clips",gContents)}.bind(null,e))}},graphAudioModeData=function(e){if(!global.blockReading){var t=tinymixSetReadRegIDCommand+"0x00 0x00 0x00 "+duetRegisterIds.diagnostics+"; t=`"+tinymixGetCommand+'"'+duetRegisters.FrameCntr+'"`; j=`'+tinymixSetReadRegIDCommand+"0x00 0x00 0x00 "+duetRegisterIds.stats+"`; l=`"+tinymixGetCommand+'"'+duetRegisters.ScRsvdStatsAudioMode+'"`; echo "$t, $j, $l"',n=exec(t)
console.log("audio mode: "+t),n.stdout.on("data",function(e,t){var n=t.split(" ").join("")
n=n.split(",")
var o=parseInt(n[0]+n[1]+n[2]+n[3],16),s=parseInt(n[5]+n[6]+n[7]+n[8],16)
console.log("before"+n[5]+n[6]+n[7]+n[8]),console.log("s:"+s),(global.framcnt=0)&&(global.framcnt=1,global.startframecnt=o)
var i=fromRegister(s,"ScRsvdStatsAudioMode"),r=(o-global.startframecnt)/250
isNaN(r)||isNaN(i)||(console.log("x: "+r+" audioMode: "+i),gContents={x:r,y:i},e.emit("new-graph-data-audiomode",gContents))}.bind(null,e))}},graphERLEData=function(e){if(!global.blockReading){var t=tinymixSetReadRegIDCommand+"0x00 0x00 0x00 "+duetRegisterIds.diagnostics+"; x=`"+tinymixGetCommand+'"'+duetRegisters.FrameCntr+'"`; j=`'+tinymixSetReadRegIDCommand+"0x00 0x00 0x00 "+duetRegisterIds.stats+"`; l=`"+tinymixGetCommand+'"'+duetRegisters.ScRsvdStatsAecInAvg+'"`; echo "$x, $j, $l"',n=exec(t)
console.log("ERLE Data: "+t),n.stdout.on("data",function(e,t){var n=t.split(" ").join("")
n=n.split(","),console.log("output:"+n)
var o=parseInt(n[0]+n[1]+n[2]+n[3],16),s=21,i=37,r=85,a=93,c=parseInt(n[s]+n[22]+n[23]+n[24],16),l=parseInt(n[25]+n[26]+n[27]+n[28],16),g=parseInt(n[i]+n[38]+n[39]+n[40],16),d=parseInt(n[41]+n[42]+n[43]+n[44],16),u=parseInt(n[r]+n[86]+n[87]+n[88],16),p=parseInt(n[89]+n[90]+n[91]+n[92],16),f=parseInt(n[a]+n[94]+n[95]+n[96],16),m=parseInt(n[97]+n[98]+n[99]+n[100],16);(global.framcnt=0)&&(global.framcnt=1,global.startframecnt=o),console.log("p:"+c+"--c:"+l+"--l:"+g+"--d:"+d+"--u:"+u+"--g:"+p+"--f:"+f+"--m:"+m)
var R=(o-global.startframecnt)/250,v=10*Math.log10((c+l)/2)-10*Math.log10((g+d)/2),q=10*Math.log10((u+p)/2)-10*Math.log10((f+m)/2)
v<0&&(v=0),q<0&&(q=0),gContents={x:R,y1:v,y2:q},isNaN(R)||isNaN(v)||isNaN(q)||(console.log("x: "+gContents.x+" aec1: "+gContents.y1+" aec2: "+gContents.y2),e.emit("new-graph-data-erle",gContents))}.bind(null,e))}},graphDTDDtata=function(e){var t=tinymixSetReadRegIDCommand+"0x00 0x00 0x00 "+duetRegisterIds.diagnostics+"; x=`"+tinymixGetCommand+'"'+duetRegisters.FrameCntr+'"`; j=`'+tinymixSetReadRegIDCommand+"0x00 0x00 0x00 "+duetRegisterIds.stats+"`; l=`"+tinymixGetCommand+'"'+duetRegisters.ScRsvdStatsAecInAvg+'"`; echo "$x, $j, $l"',n=exec(t)
console.log("DTD Data: "+n),n.stdout.on("data",function(e,t){var n=t.split(" ").join("")
n=n.split(","),console.log("i:"+n)
var o=parseInt(n[0]+n[1]+n[2]+n[3],16),s=parseInt(n[5]+n[6]+n[7]+n[8],16),i=parseInt(n[149]+n[150]+n[151]+n[152],16);(global.framcnt=0)&&(global.framcnt=1,global.startframecnt=o),console.log("s:"+s),console.log("r:"+i)
var r=fromRegister(i,"ScRsvdStatsDtdQuotient"),a=(o-global.startframecnt)/250
gContents={x:a,y1:r,y2:s},isNaN(a)||isNaN(r)||isNaN(s)||(console.log("x:"+a+" y1: "+r+" y2: "+s),e.emit("new-graph-data-dtd",gContents))}.bind(null,e))}
httpIO=require("socket.io")(3030),app.initSocketIO=function(e){socketIO=require("socket.io")(e),socketIO.of("/graphs-duet-gain").on("connection",function(e){console.log("Gain socket connected"),framcnt=0,gainDelay=setInterval(function(){graphGainData(e)},200),e.on("disconnect",function(){console.log("Gain socket disconnected"),clearInterval(gainDelay)})}),socketIO.of("/graphs-duet-clips").on("connection",function(e){console.log("Clips socket connected"),console.log("what is 1e3 : 1000"),clipDelay=setInterval(function(){graphClipData(e)},1e3),e.on("disconnect",function(){console.log("Clips socket disconnected"),clearInterval(clipDelay)})}),socketIO.of("/graphs-duet-audiomode").on("connection",function(e){console.log("Audio Mode socket connected"),framcnt=0,audioModeDelay=setInterval(function(){graphAudioModeData(e)},200),e.on("disconnect",function(){console.log("Audio Mode socket disconnected"),clearInterval(audioModeDelay)})}),socketIO.of("/graphs-duet-erle").on("connection",function(e){console.log("Erle socket connected"),framcnt=0,erleDelay=setInterval(function(){graphERLEData(e)},200),e.on("disconnect",function(){console.log("Erle socket disconnected"),clearInterval(erleDelay)})}),socketIO.of("/graphs-duet-dtd").on("connection",function(e){console.log("DTD socket connected"),framcnt=0,dtdDelay=setInterval(function(){graphDTDDtata(e)},200),e.on("disconnect",function(){console.log("DTD socket disconnected"),clearInterval(dtdDelay)})}),socketIO.of("/graphs-duet-eq").on("connection",function(e){console.log("EQ socket connected"),framcnt=0,graphEQData(e),e.on("disconnect",function(){console.log("EQ socket disconnected")})}),logsocketIO={},triggerIO={},triggerIO.avs=httpIO.of("/trigger-avs"),logsocketIO.avs=socketIO.of("/logs-avs").on("connection",function(e){onLogSubscribe("avs",e),e.on("request-log-update",function(){clientLogUpdate("avs",e)})})},module.exports=app
var NetworkConfigurations=require("./network.js"),checkIfHotspotNeeded=function(e){if("linux"!=process.platform)return e&&e(!1)
var t=!1,n=new NetworkConfigurations
async.series([function(e){n.setHotspot(!1,function(){e()})},function(e){setTimeout(e,3e4)},function(e){n.getConnectedAccessPoint(function(n){t=void 0==n,e()})}],function(){e&&e(t)})}
console.log("Environment Profile: "+config.environmentProfile),"raspberrypi"==config.environmentProfile&&checkIfHotspotNeeded(function(e){e&&(new NetworkConfigurations).setHotspot(!0)})
